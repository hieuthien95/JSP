<?php
include_once("../model/model.php"); 
session_start();
$model = new Model();
$con  = $model->connectDatabase();

//cấu hình thông tin do google cung cấp
$api_url     = 'https://www.google.com/recaptcha/api/siteverify';
$site_key    = '6LdYGwsUAAAAALjiOh6jVtQ1403qqU8SxVsw6FYI';
$secret_key  = '6LdYGwsUAAAAAHjGNY09YnkIAHiT8G65G3irDCcW';

$id = $_POST['id'];
$sdt = $_POST['sdt'];
$email = $_POST['email'];
$ten = $_POST['ten'];
$tenanh = $_FILES["anhminhhoa"]["name"];
$pass = $_POST['pass'];
$newpass = $_POST['newpass'];
$conformpass = $_POST['conformpass'];
  
//kiem tra submit form
if(isset($_POST['them']))
{
    //lấy dữ liệu được post lên
    $site_key_post    = $_POST['g-recaptcha-response'];
      
    //lấy IP của khach
    if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
        $remoteip = $_SERVER['HTTP_CLIENT_IP'];
    } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
        $remoteip = $_SERVER['HTTP_X_FORWARDED_FOR'];
    } else {
        $remoteip = $_SERVER['REMOTE_ADDR'];
    }
     
    //tạo link kết nối
    $api_url = $api_url.'?secret='.$secret_key.'&response='.$site_key_post.'&remoteip='.$remoteip;
    //lấy kết quả trả về từ google
    $response = file_get_contents($api_url);
    //dữ liệu trả về dạng json
    $response = json_decode($response);
    if(!isset($response->success))
        echo 'Captcha khong dung';
    if($response->success == true)
    {
        echo 'Captcha dung';
		
		$quyen = "nguoidung";
		
		if($_SESSION["quyen"]=="admin")
			$quyen = $_POST["quyen"];
		
		if (empty($_POST['id']) || empty($_POST['pass'])) 
			echo $error = "Username or Password is invalid";
		else				
			$model->addTaiKhoan($id, $sdt, $email, $ten, $quyen, $tenanh, $pass);	
				
    }
	else
        echo 'Captcha khong dung';
}



//kiem tra submit form
else if(isset($_POST['capnhat']))
{
    if ($pass == $_SESSION["pass"]) 
	{ 
	
		$model->updateAccount($id, $sdt, $email, $ten, $quyen, $tenanh, $pass);
		
	}
	else echo $error = "Password is invalid";
}



else if(isset($_POST['dangnhap'])) 
{
	$return_url = base64_decode($_POST["return_url"]);
	$username=$_POST['username'];
	$password=$_POST['password'];
	
	if (empty($_POST['username']) || empty($_POST['password'])) 
		echo $error = "Your Login Name or Password is invalid";
	else
		$model->login($username, $password, $return_url);
}



else {
	session_unset();
	$_SESSION['quyen']="";
	session_destroy();
	header('location:./');
}

?>